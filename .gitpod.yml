image:
  file: .gitpod.Dockerfile

ports:
  - name: App
    port: 8000
    onOpen: open-browser
    description: Symfony Server
  - name: Shop
    port: 8005
    onOpen: open-browser
    description: Shop
  - name: MySQL
    port: 3306
    onOpen: ignore
  - name: Adminer
    onOpen: ignore
    port: 5000

tasks:
  - name: App
    init: |
      docker run --restart always -d --name=mysql -p 127.0.0.1:3306:3306 -e MYSQL_ROOT_PASSWORD=root mysql:8
      docker run --restart always -d --name=adminer --link mysql:mysql -p 5000:8080 -e ADMINER_DESIGN=pepa-linha -e ADMINER_DEFAULT_SERVER=mysql -e ADMINER_PLUGINS="tables-filter table-structure json-column version-noverify" ghcr.io/shyim/shopware-docker/adminer
      docker run --restart always -d --name=shop -p 8005:80 dockware/dev:latest --env APP_URL="$(gp url 8005)|g"
      docker exec shop bash -c 'echo "TRUSTED_PROXIES=127.0.0.1,127.0.0.2,172.0.0.0/8 >> .env'
      docker exec shop bash -c 'APP_ENV=prod ./bin/console framework:demodata --orders 10 --products 0 --tags 0 --rules 0 --media 0 --customers 0 --properties 0 --categories 0 --manufacturers 0 --product-streams 0 --promotions 0 --reviews 0 --users 0 --flows 0 --mail-template 0 --mail-header-footer 0'
      rm .env
      composer install
      mysql -u root -e "create database mothership_demo_app"
      cp -r .env.example .env
      sed -i "s|SHOPWARE_APP_URL=|SHOPWARE_APP_URL=$(gp url 8000)|g" .env
      cp -r ./app/MothershipDemoApp/manifest.xml.example ./app/MothershipDemoApp/manifest.xml
      sed -i "s|SHOPWARE_APP_URL|$(gp url 8000)|g" ./app/MothershipDemoApp/manifest.xml
      docker cp $(pwd)/app/MothershipDemoApp/. shop:/var/www/html/custom/apps/MothershipDemoApp
      npm i
      npm run build
    command: |
      # Gitpod registers the ports on first docker command
      docker ps
      
      # Wait for port open
      gp ports await 3306
      
      # Wait until MySQL is reachable
      until mysqladmin ping; do
          sleep 1
      done
      
      # Run DB migration
      bin/console doctrine:migrations:migrate --no-interaction
      
      # Wait for port open
      gp ports await 8005
      
      # Start Webserver
      symfony server:start --port 8000
  - name: Getting Started
    command: |
      echo 'Your environment is starting soon. You can see the progress in the terminal'
      echo "App URL: $(gp url 8000)"
      echo "Shopware URL: $(gp url 8005)"
